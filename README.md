<div align="center">
  <h1 align="center">SoulWallet Contracts [draft version]</h1>
</div>

<div align="center">
<svg width="269" height="79" viewBox="0 0 269 79" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M61.3627 27.3716L17.3793 27.3716L17.3793 27.3733C17.34 27.3733 17.3013 27.3716 17.262 27.3716C10.5611 27.3716 5.12891 32.7636 5.12891 39.4151C5.12891 46.0666 10.5611 51.4587 17.262 51.4587C17.3013 51.4587 17.3406 51.4575 17.3793 51.4569L17.3793 51.4587L61.3627 51.4587C68.0637 51.4587 73.4958 46.0666 73.4958 39.4151C73.4958 32.7636 68.0637 27.3716 61.3627 27.3716Z" fill="url(#paint0_radial_3265_2901)"/>
<path d="M30.6948 8.59619L8.59641 30.6946C3.84875 35.4423 3.84875 43.1398 8.59641 47.8874C13.3441 52.6351 21.0416 52.6351 25.7892 47.8874L47.8877 25.789C52.6353 21.0414 52.6353 13.3439 47.8877 8.59619C43.14 3.84853 35.4425 3.84852 30.6948 8.59619Z" fill="url(#paint1_radial_3265_2901)"/>
<path d="M52.7518 30.9238L30.6534 53.0222C25.9058 57.7699 25.9058 65.4674 30.6534 70.2151C35.4011 74.9627 43.0986 74.9627 47.8463 70.2151L69.9447 48.1166C74.6923 43.369 74.6923 35.6715 69.9447 30.9238C65.197 26.1762 57.4995 26.1762 52.7518 30.9238Z" fill="url(#paint2_radial_3265_2901)"/>
<path d="M160.41 48.2095C158.727 48.2095 157.045 47.5343 157.045 44.1691V29.358L156.709 29.0217H154.016L153.68 29.358V44.1691C153.68 49.2182 156.709 51.2384 160.413 51.2384H161.086L161.422 50.9022V48.5458L161.086 48.2095H160.413H160.41Z" fill="#1B112B"/>
<path d="M219.699 48.2095C218.016 48.2095 216.334 47.5343 216.334 44.1691V29.358L215.998 29.0217H213.305L212.969 29.358V44.1691C212.969 49.2182 215.998 51.2384 219.702 51.2384H220.375L220.711 50.9022V48.5458L220.375 48.2095H219.702H219.699Z" fill="#1B112B"/>
<path d="M231.095 48.2095C229.411 48.2095 227.73 47.5343 227.73 44.1691V29.358L227.394 29.0217H224.701L224.365 29.358V44.1691C224.365 49.2182 227.394 51.2384 231.098 51.2384H231.771L232.107 50.9022V48.5458L231.771 48.2095H231.098H231.095Z" fill="#1B112B"/>
<path d="M209.79 48.2095C208.106 48.2095 206.425 47.5343 206.425 44.1691V41.1402C206.425 36.0911 204.405 33.7346 199.356 33.7346C194.307 33.7346 192.286 36.0911 192.286 38.7837L192.623 39.12H195.315L195.652 38.7837C195.652 37.436 196.999 36.7635 199.353 36.7635C201.707 36.7635 203.057 37.436 203.057 39.7925V40.4649L202.721 40.8012C202.721 40.8012 201.373 40.4649 199.356 40.4649C194.979 40.4649 191.614 41.8127 191.614 45.8503C191.614 49.5545 193.97 51.2357 197.672 51.2357C201.373 51.2357 204.01 48.7847 204.01 48.7847H204.335C205.561 50.4882 207.55 51.2357 209.79 51.2357H209.946L210.282 50.8994V48.543L209.946 48.2067H209.79V48.2095ZM203.057 44.8416C203.057 46.5256 201.037 48.2067 198.344 48.2067C196.324 48.2067 194.979 47.8705 194.979 45.8503C194.979 43.8301 196.663 43.1576 199.692 43.1576C201.712 43.1576 202.721 43.4939 202.721 43.4939L203.057 43.8301V44.8388V44.8416Z" fill="#1B112B"/>
<path d="M150.762 48.2097C149.078 48.2097 147.397 47.5345 147.397 44.1693V34.4073L147.064 34.071H144.371L144.035 34.4073V42.8216C144.035 46.5257 142.015 48.2069 139.658 48.2069C136.966 48.2069 135.954 46.1867 135.954 44.1665V34.4073L135.618 34.071H132.925L132.589 34.4073V44.1693C132.589 47.8735 134.609 51.2386 139.322 51.2386C142.351 51.2386 144.963 48.7877 144.963 48.7877H145.299V48.7794C146.527 50.4883 148.52 51.2358 150.762 51.2358H150.918L151.254 50.8996V48.5432L150.918 48.2069H150.762V48.2097Z" fill="#1B112B"/>
<path d="M100.652 51.2386C95.0469 51.2386 91.4233 48.6015 91.4233 43.658L91.754 43.3273H94.3883L94.719 43.658C94.719 46.9537 97.0255 48.2709 100.98 48.2709C103.945 48.2709 106.251 47.2816 106.251 44.6445C106.251 41.6795 104.273 41.0209 99.6598 40.3595C95.0469 39.6982 92.0819 37.7252 92.0819 33.7709C92.0819 30.8059 94.3883 27.5103 100.321 27.5103C105.265 27.5103 108.888 29.4888 108.888 34.4295L108.558 34.7602H105.92L105.59 34.4295C105.59 31.7924 104.273 30.4753 99.9877 30.4753C97.0227 30.4753 95.3748 31.7924 95.3748 33.7709C95.3748 36.4081 97.0227 37.0666 101.636 37.7252C106.248 38.3838 109.544 40.0316 109.544 44.6445C109.544 48.2709 106.907 51.2359 100.646 51.2359L100.652 51.2386Z" fill="#1B112B"/>
<path d="M120.607 51.2385C115.663 51.2385 112.367 47.9428 112.367 42.6714C112.367 37.3999 115.663 34.1042 120.607 34.1042H120.937C125.881 34.1042 129.176 37.3999 129.176 42.6714C129.176 47.9428 125.881 51.2385 120.937 51.2385H120.607ZM120.937 48.2735C123.902 48.2735 125.881 46.295 125.881 42.6714C125.881 39.0478 123.902 37.0693 120.937 37.0693H120.607C117.642 37.0693 115.663 39.0478 115.663 42.6714C115.663 46.295 117.642 48.2735 120.607 48.2735H120.937Z" fill="#1B112B"/>
<path d="M184.458 50.6327L184.128 50.9634H181.163L180.832 50.6327L178.856 35.1435H178.526L176.547 50.6327L176.216 50.9634H173.251L172.921 50.6327L169.297 30.5307V28.2242L169.628 27.8936H171.934L172.265 28.2242L174.571 43.7134H174.902L176.878 28.2242L177.208 27.8936H180.173L180.504 28.2242L182.483 43.7134H182.813L185.12 28.2242L185.45 27.8936H187.757L188.088 28.2242V30.5307L184.461 50.6327H184.458Z" fill="#1B112B"/>
<path d="M234.299 42.6687C234.299 38.0558 236.606 34.1016 242.208 34.1016C247.81 34.1016 250.116 38.0558 250.116 42.6687V43.6579L249.786 43.9886H238.251L237.92 44.3193C237.92 44.9779 238.251 48.2736 242.533 48.2736C244.181 48.2736 245.498 47.9429 246.157 46.295L246.487 45.9644H249.124L249.455 46.295C249.124 48.9322 246.818 51.2386 242.536 51.2386C236.934 51.2386 234.297 47.615 234.297 42.6715L234.299 42.6687ZM246.493 41.0208C246.493 40.0316 246.162 37.0666 242.208 37.0666C238.254 37.0666 237.923 40.0316 237.923 41.0208L238.254 41.3515H246.162L246.493 41.0208Z" fill="#1B112B"/>
<path d="M255.482 37.7251L255.152 37.3944H252.515L252.184 37.0637V34.7573L252.515 34.4266H255.152L255.482 34.0959V29.8165L255.813 29.4858H258.45L258.781 29.8165V34.1015L259.112 34.4321H264.714L265.044 34.7628V37.0693L264.714 37.3999H259.112L258.781 37.7306V44.322C258.781 47.6177 260.429 48.2763 262.077 48.2763C263.394 48.2763 265.042 47.6177 265.042 45.3112V44.6527L265.372 44.322H268.009L268.34 44.6527V45.3112C268.34 49.9241 264.714 51.244 262.079 51.244C258.453 51.244 255.488 49.2683 255.488 44.3248V37.7334L255.482 37.7251Z" fill="#1B112B"/>
<defs>
<radialGradient id="paint0_radial_3265_2901" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(63.6158 27.2995) rotate(151.938) scale(42.814 36.9698)">
<stop stop-color="#FFD8B0"/>
<stop offset="0.359375" stop-color="#FFA3AC"/>
<stop offset="1" stop-color="#FF87CD"/>
</radialGradient>
<radialGradient id="paint1_radial_3265_2901" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(39.3124 15.0001) rotate(135) scale(36.308 42.1617)">
<stop offset="0.25" stop-color="#FF2E79"/>
<stop offset="0.869792" stop-color="#FF8BD1"/>
</radialGradient>
<radialGradient id="paint2_radial_3265_2901" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(38.7355 62.5834) rotate(-47.7989) scale(45.9498 29.3878)">
<stop offset="0.130208" stop-color="#FF2B9D"/>
<stop offset="0.723958" stop-color="#FF9BBF"/>
<stop offset="0.958333" stop-color="#FAC7BD"/>
</radialGradient>
</defs>
</svg>

</div>

## Features
+ Support [ERC-4337: Account Abstraction](https://eips.ethereum.org/EIPS/eip-4337)
+ [Modular design ](https://hackmd.io/3gbndH7tSl2J1EbNePJ3Yg)
+ Implement [asset / keystore](https://hackmd.io/-YY8jD7IQ7qfEZaDepXZsA?view) separation architecture 
+ Upgradability: The smart contract for this wallet can be upgraded in a secure way to add new features or fix vulnerabilities in the future.
+ Stablecoin pay gas: Users can pay transaction gas fees with stablecoins such as USDC, USDT, DAI, etc.

## Architecutre

![](https://hackmd.io/_uploads/S1HEbO12h.png)

The smart contract comprises three main logic components:

1. SoulWallet Core:

+ This is the primary wallet logic.
+ Handles signature validation.
+ Supports the ERC4337 interface.
+ Manages modules and plugins.
2. Modules:

+ Modules provide extended functionality.
+ A module is a whitelisted contract capable of executing transactions on behalf of the smart contract wallet.
+ Modules enhance the functionality of the contracts by adding extra access logic for transaction execution.
3. Plugins (Hooks):

+ Plugins empower the smart contract wallet to invoke calls to the plugin contract.
+ Plugins can be set up to perform additional checks on transactions before they're executed.
+ There are three defined hook points within the contract wallet. `guardHook` `preHook` `postHook`. The `prehook` and `posthook` are executed before and after the execution of a transaction, while the `guardhook` is executed before signature validation.


## Repository Structure

All contracts are held within the `soul-wallet-contract/contracts` folder.
 

```
contracts
├── authority
├── base
├── handler
├── helper
├── interfaces
├── keystore
│   ├── L1
│   │   └── interfaces
│   └── interfaces
├── libraries
├── miscellaneous
├── modules
│   ├── SecurityControlModule
│   ├── SocialRecoveryModule
│   ├── Upgrade
│   └── keystore
│       ├── ArbitrumKeyStoreModule
│       └── OptimismKeyStoreProofModule
├── paymaster
│   └── interfaces
├── plugin
│   ├── Dailylimit
│   └── Simple2FA
├── safeLock
└── trustedContractManager
    ├── trustedModuleManager
    └── trustedPluginManager
```

## Test
```shell
npm run test
```

## Integration
Third parties can build new modules/plugins on top of SoulWallet to add additional functionality. 
### Module
To add a new module, the contract can inherit from `BaseModule`
``` solidity
import "./BaseModule.sol";

contract NewModule is BaseModule {
    function requiredFunctions()
        external
        pure
        override
        returns (bytes4[] memory)
    {}

    function inited(
        address wallet
    ) internal view virtual override returns (bool) {}

    function _init(bytes calldata data) internal virtual override {}

    function _deInit() internal virtual override {}
}

```
### Plugin
To add a new plugin, the contract can inherit from `BasePlugin`
``` solidity
import "./BasePlugin.sol";

contract NewPlugin is BasePlugin {
    function guardHook(
        UserOperation calldata userOp,
        bytes32 userOpHash,
        bytes calldata guardData
    ) external override {}

    function preHook(
        address target,
        uint256 value,
        bytes calldata data
    ) external override {}

    function postHook(
        address target,
        uint256 value,
        bytes calldata data
    ) external override {}

    function _init(bytes calldata data) internal virtual override {}

    function _deInit() internal virtual override {}

    function _supportsHook()
        internal
        pure
        virtual
        override
        returns (uint8 hookType)
    {}

    function inited(
        address wallet
    ) internal view virtual override returns (bool) {}
}
```
## Disclaimer
This project is provided "as is" with no warranties or guarantees of any kind, express or implied. The developers make no claims about the suitability, reliability, availability, timeliness, security or accuracy of the software or its related documentation. The use of this software is at your own risk.

The developers will not be liable for any damages or losses, whether direct, indirect, incidental or consequential, arising from the use of or inability to use this software or its related documentation, even if advised of the possibility of such damages.

## Acknowledgments
* <a href='https://eips.ethereum.org/EIPS/eip-4337'>ERC-4337: Account Abstraction Using Alt Mempool</a>
* <a href='https://github.com/eth-infinitism/account-abstraction'>Infinitism account abstraction contract</a>
* <a href='https://github.com/safe-global/safe-contracts'>Gnosis Safe Contracts</a>