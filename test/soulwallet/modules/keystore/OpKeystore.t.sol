// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.17;

import "forge-std/Test.sol";
import "@source/modules/keystore/OptimismKeyStoreProofModule/OpKnownStateRootWithHistory.sol";
import "@source/modules/keystore/KeystoreProof.sol";
import "@source/modules/keystore/OptimismKeyStoreProofModule/IL1Block.sol";
import "./MockKeyStoreData.sol";

contract MockL1Block is IL1Block, MockKeyStoreData {
    function hash() external view returns (bytes32) {
        return TEST_BLOCK_HASH;
    }

    function number() external view returns (uint256) {
        return TEST_BLOCK_NUMBER;
    }
}

contract OpKeystoreTest is Test, MockKeyStoreData {
    OpKnownStateRootWithHistory knownStateRootWithHistory;
    MockL1Block mockL1Block;
    KeystoreProof keystoreProofContract;

    function setUp() public {
        mockL1Block = new MockL1Block();
        knownStateRootWithHistory = new OpKnownStateRootWithHistory(address(mockL1Block));
        keystoreProofContract = new KeystoreProof(TEST_L1_KEYSTORE,address(knownStateRootWithHistory));
    }

    function test_mockL1BlockReturn() public {
        bytes32 returnHash = mockL1Block.hash();
        assertEq(returnHash, TEST_BLOCK_HASH);
    }

    function test_insertNewStateRoot() public {
        /*
    {
    "baseFeePerGas": "0x7",
    "difficulty": "0x0",
    "extraData": "0xd883010b05846765746888676f312e32302e32856c696e7578",
    "gasLimit": "0x1c9c380",
    "gasUsed": "0xc6deb0",
    "hash": "0x28a4e2e5e6178af09a203ae5c57c2a07c259b33cfc72a1ec8240d3bbdd624327",
    "logsBloom": "0x1462b86289aa506d47d5406e80866248080426158b645a408d04280ac0c00c480463101c16101782502988d160cc848d9b4890260c66bb04c2e41504c3682800900769009c4f024a4cfb532a872228620fab07404a6a54001035a056081a88011242b0220ba52010504cd8a444901a80885a8cc6882c0062310529178628a154828e04c4700002086f0802a5310456f048083f045d07038820c78251044604040e4af25d9001133463e079e420f5fb482411a20ba8483160a684090e021455c2d4b4282e80aa608b40c24191ec031c38c137416320000010066be9b08d41f2621410554c08a184dd14a87148f3401f481485000249900a7560c0480a46904304",
    "miner": "0xc6e2459991bfe27cca6d86722f35da23a1e4cb97",
    "mixHash": "0xa58485eba61ae4b152afe9de7aaf6e83ee2c66449d2e2a0d6911fbe8b9561480",
    "nonce": "0x0000000000000000",
    "number": "0x9312fb",
    "parentHash": "0x2559746210ec244f07617210bc8df17284e0d12c79b8096921ee7d35f4bc5963",
    "receiptsRoot": "0xf022906138957d5db0e8ba4d703a8782564290b4340cc97617cc170f3fa119a0",
    "sha3Uncles": "0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347",
    "size": "0x475b7",
    "stateRoot": "0x85864a169b8338fae769ec2c7d1fd640e060c01b2a2b0b81473f630345486f99",
    "timestamp": "0x64f68aa4",
    "totalDifficulty": "0xa4a470",
    "transactions": ["0xe82b82feb61b3895be1df147f18a95f27e9255c874aafc9799cb5c2ccde6e5c5", "0x0669e50328c9118e9cb0ed811f19988af7e1837a69f7be88479d31df69ced297", "0x894b1675aeb63882a7e850345a15592a7c0032f155a158aa9292bc6f7b39c12d", "0x4312ed3cac2ec1ab292d22cb893fdf97cbbfe56df58f447ad4d3c44084eab51a", "0x67253362077421d71aa80156db79eb914b356443c280ce3194f10aa2b815b3a0", "0x6152aae631a2324c8283a99b5066fe6b4eb36c8a5e22db70d5fdc54896f1bb5d", "0xade93f5acdb44fba47c0f5fd7a55075ef4f5b08a04457f529acbd095af15586d", "0x9e9119d09f1436e274fb6b258b4578ac729250a566030ddf593f4610b1049b85", "0x0b27d60a63977f732e2e063fcd6d4118c723ace355c3a6c1d3e977caa2c8cc6e", "0x6df7dd1ff8cea6a1e94804df1e052d5c411cb0668dd25091252413bfbe953a04", "0xa90cd1a03b1ab1800b19a700ccc94ab0c98968fb6a91c563c69db2091968244f", "0x82fa3d37a068b0abf358d5774e618c57b144630c936097fbbea1ae5c09c3ede9", "0x1c8e663abcd6cb3b58b6ed12c81ff02a4a21bb7e7650dca9f44583256c7d4b52", "0xf963038f04387f00e4d69871c5d40ba7c6cd524eede9d597570bf011b9fd5050", "0x500cf7bb9cc923533583947d788f0b87c083f986c70f43cf4e19280e31b80ca2", "0x51fc169106bd9e5a4cd1799a4a4e804579c7078bb6bb08235641650e7c959cef", "0xb5dcccfa2a4ca70f10b6ef755f7e3950a0cc652ad3b2bc068b35ef10da4e6c82", "0x25c38b13a0886970e85f50ba0a2a34040ab5ab374551af5473cce4fb8fb080ba", "0x1eb4ecb374fd58c7af0f156aa950358f63df68f87d2dbc4f9eb9793ebeb04b32", "0x45ab02f6355770ab3b47dd3f7cb5092288e633531f69b088b57eb3673dc7226d", "0x5fa9d5765772019ca96d19aeef3d32c67ec02adbf04fe7baec07963a5256c61c", "0xbecb047ac4c67e3732a8dcc25cc5ed6651022de439844c9ce7731ad67c7b01c6", "0xe8fdca8bc25080d59228bb4e2185101375c366c2b5801f95a5eae41602b72b38", "0x9c5ac0cd5e34a7fc6466b014cd3a83f699852ab69738f496a16149be34752674", "0x116c565d2f5a7810c3c0da30a2fc786f42903524a4d6f9432d835efb7a053b4e", "0xeabfa64f22c30de386d1740808b07a944b545165eba45c0e5780cc41016aa270", "0xd59da630c462a14e2e11796898ecdfb4c8193409e0cc875e740e9a46799a2ec8", "0x6eafc9d026a060ee0feec3f8876375b9f5caa03af4acce21c9cb9e946ffc80a0", "0xd159eac13f47fca16ffed889e2f78e60e5e7f8cae53ed6acebb9aa89f0a4352d", "0x17d91464cd86275b2e593b7823419d9fbab384087ae46fac15fd4302f492c416", "0x8db80b3d39b539220725db1e9993db39c2d3b67e88d58ce968a51a64c47a27c5", "0xcc6c2508af09fba27db18957c0e7cbff3623f4fe5cecf60fc21e40e22defd87b", "0xbb38c2f92c28640effb2fee064e62ca8a2e850e148e11c68667e7724825829ab", "0x566b2b2e95958d8b7c64781731ad502b195308de30424246d5da7eee6dddc1e1", "0xd97924fde62d1cc38ee919ab80cd49232387e101dee15503333bdfc2b3b4505a", "0xc62a60a48665bb45b5b8f0d3c12c74eaf3e9d974ca69eb0813c3f4812a753f4c", "0xf59ed13bbeb5002c65beab3ab4cc05207aae4844764b45d20b6c06c8c4daca8b", "0xab1d15315f601075d600da57149487b7cc2976884dcd3991657df62a46bd0b6c", "0x09913a62b93919a500b25906b18cf10c62557e379dd2cca15d8923d6a6ef4b29", "0xe0d2d6d132673a3bdf403371160ca253ac26cc41643ab05f020eec5ad33136a8", "0x245e92ef1d0c3c23456c3e16a79c079f05d705e62ba19b8b10865719acf78b33", "0xee09ccd40cda644f2c5f847136456d79b65912512fdf1834630264eebddb13ef", "0xa08ac08e90e02b7a9811aaf80bc2c4e9d26bd611a6a0b51029e7302b4ca7dc53", "0x715b10ae16ed48df1af1234c8fe569dcff20ed5ad7879d166aafdd66384525d5", "0x324ffb29c045445cb79bc91a1a016e0850044095c3291b67c0261892a7157d2e", "0x15cf945ed3e095a9c75205101c81c49b0713b10215e6c8852fb77bc5fb8c0701", "0xaf6f7d3ade8469d74a3f336df16e3190b278735446569e3f15950d046dd3357b", "0x2f3d0f20452bafa2643c740e8e5b5e8a94c04bfb9a00f324bcfc260d52eb291f", "0xa8ba5c3fc5a6f969bf8cb2234de3ec7f66d96d4bf5b48e06d25205dbeec54c7e", "0x059a804e98415bc818f66a241c534834ebc20a3a3d31070acee1f6688d7bcd69", "0x5fadaec89d0bdbcefaf420dc1d484179d4b00e6b3f664427f48476b29feb40b9", "0x0715419839c0ff397814edfe4d120e5b9279ac9e95c7aa4009fe248e64259e9a", "0x2fa4dec708169a86aa0495642fd36b3293a70cbc777d106114cd1699317a802a", "0x7dda3352d21f354ce812cda14ddfaf1a2bab50c3f86f3bc61c4cb84b76bcd3db", "0x982fff106001f99d5e3121733a2e56569176536431e02ab4ed6ea8f001961292", "0x4d1d74ce13ab5b1474411f8dbc4afd670478d6d50cc7788fea85b4882e86270e", "0x66c1a27ea99f52134816ef4df19c83de8837a256fc88039b3d9b9202e55de6e2", "0x106cfb0a55e374dc2b18058457ac2a87cb1e360e610affb06db2b4787a461a05", "0xbabc6f4977315068aeebb2aad6a71706920a60ad8e493412335c37cd6012cba5", "0x62804d8026ca82a463cf88c16d123b170f1fa1eb5fd298ee822759a51f78272b", "0xf7d8884b39baf50263797ac85213a35b0f5ef07183512d18b4ea76b0b9d69a61", "0x990d7e784886a5b3125a8b7f829848023f25b2ab27d2c3c11af98c5fc5872114", "0xfed05579280a7a071d6e5e5971ee72b6e4fb9a8c887ebab81bd0b69031b5788b", "0xb240a22fbe84ccf7da8e0db630fab139a56e5f607b3484eee4e0af6114f82ce4", "0xa1a8999805a8059aae035773d86e88dd745d029264d56ba0db94bc1d9d2e1f68", "0x2d7554db8518871a7a3113d66d40ba485f71aa296aff55b48e8307dc10372d01", "0xe804f0c95c6bd7ac1e839255520c1b1a389e7bdc3420523f45b968fedbf1839d", "0xea6d5b1d0454d481baee7eef43048e13ae4e28e336c7f28d69759c3af8a04260", "0x59e726a8f9b96f037df22927413f5ad9c9a18520f91353577271f269778398c1", "0x72a77c1c91250fcfafc7513a864463c12fc880369e0c7d1f73ddf4f5265b7ca2", "0xded1f2b76062b6b95cd546abf24bc4788fb7f56069238e23bd3dc5dbe0a8c21a", "0x0fc6fb5c855e1110112bf52942c30a418fc775a28bcc90e8984a3980a0496b73", "0xb1d4958609be77b3f8690c22ff0db8f3cb02f51372b08744465b1397fdb013c9", "0xd3797ee517fb958f1b8d787f1a768bf218029764f621d412243d439b096a669c", "0xd09eb8604876885e88ea5342f1a92c9ccd6c6e0c9874f16ef3de144db6b3a554", "0xea1254193c764e52e1a5dfb35943254ee691ecc4fdee47fa9a76457c54280a47", "0x0180b1ee10861587bc9222eb73d4ccd06437c4f4c9f9cd726d840399cb1f7cb3", "0x1b710904a447f265d123655c22ce9a3fa501520fe9a7e194c486fab40cafcc1c", "0xf36b3c55133c0cffe2688ee1f4e3a865092aae157c2ceabf85342bab22740055", "0x2dee75a8afef07cc22f8b349f07a36d4991f6e90f56e206640bf7663e34762cf", "0xb4bf7e8625ca42dbafee1029815b5d1338f0c5024802419dbe773e203459e588", "0xfc17cef3ff7908447f27df8c79bf2134ce74df4086d815b0607fd6d987b5f0ab", "0xb9bc963d847d4d71ac5bf84051fd7224e15e8b42932be2b1bf545fc18d23f723", "0x4e6199b7851e1a0008beaadcbe1b26708573bb39d09c34d2dfa00b9d2dfda815", "0x2314fb0f53ed8da99eb5d777df6f2df7fe73a96fbb4d0082770bb3dba2d45a92", "0xba55636f477ed3fb7f96c11e6645b9a2de5a681af91de4ab130293b295b43ee1", "0x00d04d33a9ebe165d6dac894c5200e7a1c54b37026202097e128e0a8ee6cf510", "0x4815ca34c39db4a7c3857a001553ab9424dd1ee17f6a0b331e07f3daeec4da89", "0x026d0e5969b506be9570d9cd6f59d695512adacf706fed8005757bf41d062609", "0xa59714956a42d1fd70efcf64aaace14bf3f236548c9d7cf54bbab761d83d747e", "0x7d8852b1036f048e8d3f9a56c712db67049f8f9c704db957910b0e5a7d2ebd9f", "0x63c8fec2088df5455588c92876bdb39087d4c06ff80b8ad397967c4b8be50ce3", "0x20c1a1d74209093f2e579136c21d7c3bb5826b9dc7dce8f1f156142008b635ec", "0x57ac5032120093ee0b58644ba2be06f68d00da66ccc9e26bf0a1ebe53e427f96", "0x02fb7806769c4afe9318126b08f2419d6613e4a45880f4fba7a9fe710f4c7172", "0x5ceb9a868d518a0b8b8d1b07a5f48e7b9cb297a2a3b614f62f65047ec5b6b430", "0xc332480c89da60abab2bbaa47180467e4d345dabe7a0b111cf363a971826520c", "0x0760568f5bc0edda219ee909ab7f82b95b01f8ee096acc26b5cacf2945b40ef5", "0x89a629476d777f015958693fb1c8422dbcd9ae4e4eda2302b74d2b0644d475b9", "0xe6a7b22f8744fd8c087e60c411c8923128fafe94723640dab13eee13fa076ba8", "0x4c8f400fb72d99b38d75e3d2f557d315ddb58ec1dee3b58807438c4cbd9465de", "0x54e6889b0d6c286b73a739dc924bfb6ecbefa794619d12c6c4dc4d3d27cdc335", "0x7ea82e16e96be523559962f16d80c391200dde34541ffdc1a7bd5b40e73afb50", "0x65112e7376bd279012d752fe392111cd00af0b99b666429b103a5cd71b025ca4", "0x283eb084d9a6a5c741d448b26cbbeb06cb168b85f1d29abb38cb3614226fe44a", "0xa7b855abaa29866b484aed5e5123790e0bc9cc5cd0ad29e0cb6baf750eb7bb82", "0x87ddf8e4533df9be1d41c12a66bfb0c31fed4213e2fb4f4105b7d3c04a5d9459", "0x4f6e1e80f2540aef8cb6d43b4d15d810b1de8864c1b584c3c31ae030e49042c5", "0xc6622e8570ea8886362381e99d6c74c992264192262998ffea2d0585346d8314", "0xa6752675d092a942953c047fab47c1d73728b15bdbb8452fa4f831bb915dd829", "0x3f87a4d81c2bf6424433a63f0d40cd979c7725cb1df6d8ddb255c9a60e01d602", "0x51cc2854200d3341d44887a589bc0e66a997eb8ec9d71a6ac78dd9437ffd4bf5", "0x94489173805ad53bbf02d6b2b31a5dabcbee9a4a406bb0b2ce5c12ee4431fbdc", "0x08dece0b8e57af57aac542765f824d1508b74de64eb0d26c1ef85569dd19d1b2", "0x9a0cb207aba734180382b5b461131c098a5b95344a62d211c417927488e15596", "0x9d384fa4fddf90ffcb945a52f2a45c6e40db84bc4f57ef2fcc63a8dc0de6e860", "0x557f7edf125a67c77497c38e7e15c9ec1feb1c1a9609e424d6b9c5a46a5e4bdd", "0x6ed66b8ecac820d7daf244baef072303ba5ee549ff334ae26238a6ad0348c6e4"],
    "transactionsRoot": "0xedf3ebf44e97d4aafc8cbeaa72e58f8452814364ce2309a2628d56c9b37a2c56",
    "withdrawals": [{
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2dbf08",
    "index": "0xef6f79",
    "validatorIndex": "0x8697d"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2da53c",
    "index": "0xef6f7a",
    "validatorIndex": "0x8697e"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2e212f",
    "index": "0xef6f7b",
    "validatorIndex": "0x8697f"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2dc9ee",
    "index": "0xef6f7c",
    "validatorIndex": "0x86980"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2d411c",
    "index": "0xef6f7d",
    "validatorIndex": "0x86981"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2d2a5a",
    "index": "0xef6f7e",
    "validatorIndex": "0x86982"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2d1cfe",
    "index": "0xef6f7f",
    "validatorIndex": "0x86983"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x1c2c715",
    "index": "0xef6f80",
    "validatorIndex": "0x86984"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2dfbb5",
    "index": "0xef6f81",
    "validatorIndex": "0x86985"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2e3bb8",
    "index": "0xef6f82",
    "validatorIndex": "0x86986"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2d936f",
    "index": "0xef6f83",
    "validatorIndex": "0x86987"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2d0ad9",
    "index": "0xef6f84",
    "validatorIndex": "0x86988"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2d5422",
    "index": "0xef6f85",
    "validatorIndex": "0x86989"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2de3fa",
    "index": "0xef6f86",
    "validatorIndex": "0x8698a"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2de551",
    "index": "0xef6f87",
    "validatorIndex": "0x8698b"
    }, {
    "address": "0xd67b02b7f8b11206c055dd4939ab27921085f774",
    "amount": "0x2dd6e8",
    "index": "0xef6f88",
    "validatorIndex": "0x8698c"
    }],
    "withdrawalsRoot": "0x616479e147c09a89923ff56f21faa731f7523a6d81138f96fc7928b53697e7ab"
        } 
        */
        insertStateRoot();
        (bool result, BlockInfo memory blockinfo) = knownStateRootWithHistory.stateRootInfo(TEST_STATE_ROOT);
        assertEq(result, true);
        assertEq(blockinfo.blockHash, TEST_BLOCK_HASH);
    }

    function insertStateRoot() internal {
        bytes memory blockInfoParameter = BLOCK_INFO_BYTES;
        knownStateRootWithHistory.setBlockHash();
        knownStateRootWithHistory.insertNewStateRoot(TEST_BLOCK_NUMBER, blockInfoParameter);
    }
    /*
    {
    "accountProof": ["0xf90211a0231dccec83dfc1fc4022ef2c97078e55909065dc07c638926b3346f918b6c69ea0fb794ca3f647d0d0c0edf0ca25a7cc9dc7ecfcda35bc5f1a88893e1e1e53c517a01d754479e8885b81a3d081d464996cfdd31b49f2a536b57f825ee3250d621066a03d368540f30f5bc0fda02a48c1594aab680e5f598e6a0afa92c707c0e6da334da0667c3d57ad831f4c02e4e212dbd3071952c6fc14a2eeff7ece4f075c49b9df97a050b35f80af934ae1564ffd2496b694a18afb5d94b9cb32850f348252a06d8028a06ab7beccc9c5d9debe41502d74997c2507021e275eb8a5cdfecb53c98fac417ea026b67f2cb556c0f0d2231256552a0f955ee943553db0b6d17b0f08fceb140921a0ffed9cf3ac9fce0ede344ea091de2c1447a33624c30beb4d41a9996a89e984c1a0a1f37af44a23128c5f47ec055508b065c8213b78887ac178fe8211f2b17cf08ca005576ecb94f51a6f8950facb37b7e18824b2814b3774e919643a9fda31fb448aa03907044f0cae5e008e0c40f56a4dc9c2ed843c2531f0faf9b7356936336e18e0a0c428ad86f9f0ba4b9ad0fad8785c3ee85478656fd874f6198010aa9ca91a1c9aa081e829bea3a2a86d7865bd3c8686b832afd2d398d4552c07cdaed89b8dee66f2a0b32de7cca3b3a72cb2c0388782d680a0735d4bc0f159b9ad119cadc7c66fae17a0359956304177794bd71d42c8023266678379b44e957c80cf07365ed100a1ff9d80", "0xf90211a01fd69847ff1afc68a1d1c4f91575cda56d0b9e84f5757052e7895be07603c26ba0f6c11c32ef9e0c6c5130a6ab0308d9d0c9f6b1b73a1cd8e1bcab2348d9c4c20ba0e0187e5c2302b3c62defc7dacb57be2fac2cfbd7b9258ea0bf1bf5e3a8852df4a0817643e55837de8e76366de2ae6033982704cd2ad942e61a5099b1dfd5a70472a0d5d729fa400ccbfaef34e0fa4c654a65f84e23f0cd9726098af2ebaed3ba6f08a0f620ed53991e0b8e08dfc30889aab7968bf98317bc1fe2faa2a79aed1519486ba04d65aa76ad1942812ca3ff3e212ea86e053b4d4eff97deb621c063c08dbee6e5a0b4846de6ee18c7e8325999fafe4e37afed70740b7638c8f3642a3749e9848a0aa00195f44aa1d64a1700975287432fc48564f2b435fb7ce8e48e0b4ce843c71e7fa0e22954573ce82aebc5831e0278b393492e685178dfe8009a7c28e02bee9b45cba09e676d5845ebcc01ee5baae4e906d16eeb2ac6ddd66f60e3f9085bd1396e6bbfa0e5a7992b50393bd0744e34cc52e08655091bc2763efd9f8b6908c42123996d66a09eabe50d9af38689ce9f769e0cf59dbceaeba9042e9e0bdaef30a034b27d1a6ca0e0c2e5093d38fc118a082bcdc5bd9458152024279ee1f340e9ec31f92c8ff1b9a0d7d7d834023689965e2574d2b8670e20d481089a571157a3d44ac3f65622f7d2a0c5af1ed605093f5c1ca6918c3374392b6b5fc421b84e733f945087668908fc1180", "0xf90211a09f56cee06db1585464c7798457a6f9436fa3024370539e9c4c8f7bd2c8465a1da06d2f0e7e4a2919b6a68fe89cb060bc093ad3998a3d663555b0ccd052baaeb25ea044786ac95fb51c97a42e492f276d87a33f5b6c44f797a6d5b610c8eb5f56221ba0e55aa4955df48202836c63106a64289f76abcbe78d33e71e2f9e48f6992b83c5a06cc9046a8496e8b125678c849469bea9dc013cfe46c187b760a8a986dabcc1d0a070ae60dbaca6c02b652db54621cd09811c0e95dbaad4bab0d7e087dccec00b3ba0de723cda0e7614edecb885dc56287336e10eddb6a07e497e2bce677de5b63204a0495de211e23bdff808ef6db46a506e6fc1a067797e43b7fc67f9b688e66381eea0f5a570090a66bcdaf3200fd65d6df688cfb02d4abe05db2a07103bf9c86fcfada0fd68ab4865ffc5d77f95e3f7151385889f1d7499df5f4b9b18d17b6f3b2cfdc9a0d2d1fa1dce9a935cc100d9f99f59787f7c8214c639f6d3141fa79ff481539c85a0d3bf89a0d8ca98ddcd0188797f5cc92aa074507c2fc521b636070d64f02364d3a0e62de61354b83aa6e37365be2d490bd9fd5970f48f23ef20239aac42b0858734a0d3ef19924129208ac3876ba2bcbe2e1a6147e78c15788e34f3a0617b9c15207ea0178a144207497fa21866d2131359889b69bc2e6517fe304b4acc3bb84b9f2621a00a15312caa26cf498ff4a8a3d4434d675e9d1a827614a5433fab137d11be4c2b80", "0xf90211a0231c07fc82d6602446605de222f8d0d322be3a536d176fd8b48b1cc09254df29a05a9146c4a9611aeb215217d78357ca0bcc162b0ce37f38186c2fc4aa9df66b78a03eb373a92aa60053f0273cdddd4dacb8ecf36258fe2121512f3571fb094d7556a09748cc806ed7a4e337fce72e1ea40a35c8821b12dc7a70350ebdaf52edb34b77a0f22a05a3510faa4da5c7bed00544fb99b7376dac1d9cd7a6d600b3aa8f7593cfa0cf3df1efc67b26044d9a535780e8d7d629129dbb4962dc7cf9a64db5e3ace3f7a0d9fe5a4023e72947fa021190a1ccde87f608f4e0f724edf536f9050d6de66490a0ead49126d90146f688308777363181078b3b96b597fd78a550d6ff02137c5b0ba073f5822d8b635fa272317dcb7b29677ba41f479669314e2ec1233c1304098120a02d8115cade85408000717120a1cbf700621e1e14cdb87e9a885808a6256ed667a0e7ee10d8ad1087fb60d05277e2bb9adde28e9b7746b117cbe1af22048233d72da07801ea12e4c5d95f51a44acfea1dbe565200d452dddc907c9d8bf6a73d7aa76aa02a86bdde73ca633919e288e066e4b61acc5c664f8ba51441215e0c1735d21aa1a0f664a487140befc4f27247114a3d6b27ee51659dbaf09e4f30ebaa8c37ddf9f4a0ae541634a227784331dd35951f4551b51bfc1c258531d6b5da34176fd3a18794a06a1e788ebd90317fd9934d3571bd8fa17df850477625e45af90fca4b6bf482ef80", "0xf90211a0395e874a46820ba96af5166d105ec6893d7083a143e219757e3993ecd4430515a0215b255eb75c99a30a9670a7a80c9f46312db7fca42fe93fccafc571dd12c742a06675275d8196de6a126a9c1278d8041eb7657e5d6d131026556df8b4705b0524a0ff5c6c5fdb872f787f68d05916a0bd277a6351c551d77f16854165542090f26ea0ee191552ae3f7ee86860674fd7d3580842734ff685f367d1daf2178ce59a3c98a06b1bad2d970292a72b708becf8ae09b3d5eded5effaf8abb916da450109a7478a0e33a7737f3912d9f6267f8ecb862ce08e85ba3acaa8fb978c9035fa42503b83fa08978d9c04c69b9e2e19145c366efd07139b03722f4498abb9af6834e131dc90ca082c357deb9de1a3a16f4a0aa45a4fcfb02ab6f49a050cb6a61aa2b3a0591be3da095b262492641412536ceb8b8bb5a21a4f25d7e45884e41bb5f26f3ec00bf64fca05c29aa5980168a4c5c964aa45d884c1e3d931ac9ac4a239997053662bd845d87a0170426fd08a26508e99a56568fc0716f69096f1ef81b7872a515a4fe5368bf46a0d41e90d54e6849e38fb7f8d500844178f4db61001cec4b836875f868f1c8a7c7a01ceb2bdf605cc2626b7869c74fbc0fc68d320f46b42a9b99456d3475fc21b6f8a0d733a6e92fd3797390445594aeb5a317039a0eed7382e9ed95bba8997757f5c9a028a148fa3e146991ab9a570d41686c948f2fa341164702ccf1fb8f57c29c4a5c80", "0xf9019180a0084ded7c5cb2333fa90c201e597f95115280d4bee625dbe37fd1dd2c83f930f6a07d938c842fb553c60174ffb162ac49fbf90717c20b40a39826ca8461c91e1a05a0f4755afc80ca930b83a6335475c1057ec63635b03a4ffa78426a1c799db387e8a0d5ddd4dc9c149e2ebde5c08c4aca33314219f89c841cd380b3939d2f8a51aa1b80a03a9192688217206a63d252bbb65b865126feabbd628b5b055de02e2853b79f0080a0f9230db6d759be2ac53ed4ba2af9c7139c8efa4feb154f90ecfac032a3801e1ba0c2230d0d20b1849077557ebedcab4b7e2c6aac6a42c27349c6ea7b188c7376a380a0916471368a669a4152892d442f0a07420d4a0944b063ba30550f5ba49ff7dff5a0d47224012ab9fccaced1a96f0df12699c3ac0ef44c088cffa726a3eb7fd9d071a01b35987dc3c4b2c62cf5229c224aad26a53276f39e76f87945be5a403963be2ba0aa54576cb432879ef00c521371ebfb0e34cc15ff55f27df6d5d340095bd3e4cca074d9093cb447c5aa4a74f8ae553eea99e01c30bb2dc239f1998375ed6bbd09ae80", "0xf851808080808080a01f5f6b98493e3728691ace3164b52b69ed283a6eac7d634d91d4ca04cfff913d80a0e5b465b8529ad77bd1509b1ab9f6863d2f3d3bbad0689077048ef43bc24a18168080808080808080", "0xf8669d3a9bb014df8577e5cc6187edbf990ecef57955592ca967d2232d51e153b846f8440180a02ba50f51d182e12b2cb2a93d97c1e06e8a9064997cecc85575bd774a96534c1da0f32bcd791b995b2542826e48bbe37380ede9a2d86e2faf069e086f4c82aebfe8"],
    "address": "0x76a43ef7cc3b49736951759494d2aee8cae1cdec",
    "balance": "0x0",
    "codeHash": "0xf32bcd791b995b2542826e48bbe37380ede9a2d86e2faf069e086f4c82aebfe8",
    "nonce": "0x1",
    "storageHash": "0x2ba50f51d182e12b2cb2a93d97c1e06e8a9064997cecc85575bd774a96534c1d",
    "storageProof": [{
    "key": "0x5eab23faf5d36216321f982a2eb86f459814ef8f0067ef6e5e7fcabc0bf4d540",
    "proof": ["0xf90211a08c82a3d3c09e6595c7a9566b3e249633f265deff8f86135a6ba45c6625497be9a0171d96b4fb8daa67b087dac812bffb6e1a38281199bfe8302ac1904f16d90777a051b391865ab732bcc09ff1c690184d171f17644a76f2bf8d80335e674c1c9ae8a006635e9b4750b48bf2e01948df70068958d4da4b57a0cb2e5862dce0f0d2b8f9a0a10509c5d8120a7a767b1af164a04b062f4f137bcdca86c025f14a88582dff37a086a929d25572cd15c06ccf9da1dc88ad3cb51ac0ab3847315d0c4312bf2d61b2a0c80a2919e6d7f826de2133172505071d7e19ac8ac4bc21fd45092f4d58117217a0da980a71f16323249c5c172dc1dd2963ce08319c8dd40a1fb05ecd0ebe858f01a02fa5a3e03e38732e2d9df5dc1981e3dea9bd13212ab2cde969df989861cfef58a026b44ff80e5a939e665f54fe88d72d0c71acc6a93a8d35f7a81786d05c614348a09ec216cfc4db332a3aea22fb4912f0f27e643cc8690126789341b706cc613e96a0ee1bf7f7d4fe82a6fbf48f0ede9e0a2b25011f550d1433d2cd4a345666e99c51a0ca11267e6acf5161f25605924c7fc9fd155dcb36e7f50326d73f4bec198ff013a01210ab6609159812d55cdc6fab5345e9cf4cdc7c43abaa58d5f646a680a039e6a0bd98ce2eda2514f04eeb3287479721b73316bacd8f2257e0345f19d22d2eb72ca057e8b0a7939b9ee6c58058a8c94c4a4bb3b1208340fd37373914de51000ba47080", "0xf90131a0010a2afc869048cc5f8a988c54c5c10f8f6bb3b1aa4835493b054c35b1f0a06fa08f796e62e3839df216379260a5800d5a0d45e72f527d52865972f62fe2e5d7d3a00cd8ed63b8dc31078bf81505b62c05cccbb85824b22aa37f7374df96808ba44fa02071e47525d17febccb75c939070097a1743b036f4152665e711dc7ebb5aa1a880a0106531a9422449501dfcaaf4bd8372ecea7162b7140b17ae2451426bf7fb051d8080a06178017f1fd8f5f1798f49911c74cf11ab367ed6ced274a4173605aad255838ba05c19cd55894b32a6b9f4ab022b5e5e379a3334125a00fd736c437fd2780f37848080a0f0560790b764764c52d77d5966cd32e1f9f3cc12308642aa25436023af70aba78080a01e9ecb5d53e3a8a8e4d73d05520e64aa105e5b56c149cb20616235779e6b0fdf80", "0xe21ca004a934b0fd06022fb146a716c3e3c05944b0c515f2b6bbf4aa5ed27e9e1995fe", "0xf8518080a0427d3cd6e3b177827365ff4a11019dbf00bf41261b21fd2459c42de0039864e4808080808080a0095d5897e928c5b909582d4c29f16569bbeb79812114107d57b0a34a39c92a6b80808080808080", "0xf69f2055b2e37c6f762e99f002c06725a75d9af8b24778e81ae026b92b757f0403959488d66e420089d334bbdd13ab08cdfeae2710953d"],
    "value": "0x88d66e420089d334bbdd13ab08cdfeae2710953d"
    }]
    } 
    */

    function test_proofL1Keystore() public {
        insertStateRoot();
        keystoreProofContract.proofKeystoreStorageRoot(TEST_STATE_ROOT, TEST_ACCOUNT_PROOF);

        keystoreProofContract.proofL1Keystore(TEST_SLOT, TEST_STATE_ROOT, TEST_NEW_OWNER, TEST_KEY_PROOF);

        address newSignKey = keystoreProofContract.keystoreBySlot(TEST_SLOT);
        assertEq(newSignKey, TEST_NEW_OWNER);
    }

    function testFuzz_proofL1KeystoreWrongProof(bytes memory _keyProof) public {
        insertStateRoot();
        keystoreProofContract.proofKeystoreStorageRoot(TEST_STATE_ROOT, TEST_ACCOUNT_PROOF);
        vm.expectRevert();
        keystoreProofContract.proofL1Keystore(TEST_SLOT, TEST_STATE_ROOT, TEST_NEW_OWNER, _keyProof);
    }

    function test_proofL1KeystoreProofTwice() public {
        insertStateRoot();
        keystoreProofContract.proofKeystoreStorageRoot(TEST_STATE_ROOT, TEST_ACCOUNT_PROOF);
        vm.expectRevert("storage root already proved");
        keystoreProofContract.proofKeystoreStorageRoot(TEST_STATE_ROOT, TEST_ACCOUNT_PROOF);
    }

    function test_proofL1KeystoreWitoutStorageRoot() public {
        insertStateRoot();
        vm.expectRevert("storage root not set");
        keystoreProofContract.proofL1Keystore(TEST_SLOT, TEST_STATE_ROOT, TEST_NEW_OWNER, TEST_KEY_PROOF);
    }

    function testFuzz_proofL1KeystoreUnknownStorageRoot(bytes32 _stateRoots) public {
        insertStateRoot();
        vm.expectRevert();
        console.logBytes32(_stateRoots);
        keystoreProofContract.proofL1Keystore(TEST_SLOT, _stateRoots, TEST_NEW_OWNER, TEST_KEY_PROOF);
    }
}
